import streamlit as st
import yfinance as yf
import pandas as pd


@st.cache_data(ttl=3600)
def get_price_history(ticker: str, period: str = "5y") -> pd.Series | None:
    """
    Busca histórico de preços (Adj Close).
    - Suporta ativos brasileiros (ex: PETR4 → PETR4.SA)
    - Usa cache para evitar múltiplas requisições
    """

    if not ticker:
        return None

    ticker = ticker.strip().upper()

    # Ativos brasileiros normalmente não têm mais de 6 caracteres
    if not ticker.endswith(".SA") and len(ticker) <= 6:
        ticker = f"{ticker}.SA"

    try:
        data = yf.download(
            ticker,
            period=period,
            progress=False,
            auto_adjust=False
        )

        if data is None or data.empty:
            return None

        if "Adj Close" not in data.columns:
            return None

        return data["Adj Close"].dropna()

    except Exception:
        return None
